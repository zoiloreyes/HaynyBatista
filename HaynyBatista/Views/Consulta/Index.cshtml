@model IEnumerable<HaynyBatista.Models.Cita>

@{
    ViewBag.Title = "Index";
}
@section head{
    <link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Anton|Fjalla+One" rel="stylesheet">
}
<div class="row DivRowImage " style="margin-top: -20px">
    <div class="DivRowImageForeground" style="margin-left: -20%; margin-top: 30px">
        <h1 class="ImageBannerTextTitle mb-2">Hayny Batista</h1>

        <h2 class="ImageBannerTextSubTitle mt-3">Psicóloga terapeuta</h2>
        <a href="#calendar"id="btnSolicitarCita" class="d-inline-block haynyBtn p-3 btn-danger mt-4" style="">Solicitar Cita</a>
    </div>
</div>
<div class="row">
    <div id="calendar" class="my-2 p-3 bg-white"></div>
</div>
<div class="row py-3 bg-danger text-white">
    <div class="d-flex justify-content-center" style="width: 100%">
        <div class="d-flex flex-column justify-content-center" style="width: 40%">
            <h4 class="text-center px-2"><i class="fa fa-envelope"></i> HaynyBatista@@haynybatista.com</h4>
        </div>
        <div class="d-flex flex-column justify-content-center px-2" style="width: 10%">
            <img class="m-0" src="http://via.placeholder.com/50x50" />
        </div>
        <div class="d-flex flex-column justify-content-center px-2" style="width: 40%">
            <h3 class="text-center"><i class="fa fa-phone"></i> 829-846-5445</h3>
        </div>
    </div>

</div>
<div class="row">
    <div id="mapaConsultorioHayny">

    </div>
</div>
@section OutsideContainer{
    <form id="frmNuevaCita" method="post">
        <div class="modal fade" id="NuevaCita">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="d-flex flex-row-reverse">


                        </div>



                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body mw-100">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="dayAgenda" style="opacity: 0"></div>
                                </div>
                                <div class="col-md-6 ">
                                    <h4 class="mt-1 ">Horas Disponibles</h4>
                                    <div id="FechasDisponibles" class="mt-3 d-flex justify-content-around">

                                    </div>

                                    <h4 class="mt-1">Tipo de Cita</h4>
                                    <div id="TiposCita" class="mt-3 d-flex justify-content-around">

                                        <a class="btnTipoCita btn btn-info m-2 text-white" data-idTipo="2"><i class="fa fa-skype"></i> Skype</a>
                                        <a class="btnTipoCita btn btn-info m-2 text-white" data-idTipo="2"><i class="fa fa-user"></i> Consultorio</a>
                                    </div>
                                    <h4 for="txtMensaje">Mensaje</h4>
                                    <textarea class="form-control" id="txtMensaje" rows="3"></textarea>
                                    <h4 class="mt-2 headerTotalConsulta" style="opacity: 0">Total: <span class="text-info" id="totalConsulta">RD$2000</span></h4>
                                    <div id="MetodosPagoConsulta" class="" style="opacity: 0">
                                        <h4 class="mt-1 ">Metodos de pago</h4>
                                        <div class="d-flex justify-content-around">
                                            <a class="btnTipoPago btn btn-info m-2 text-white" data-idTipo="2"><i class="fa fa-paypal"></i> Paypal</a>
                                            <a class="btnTipoPago btn btn-info m-2 text-white" data-idTipo="2"><i class="fa fa-money"></i> Consultorio</a>

                                        </div>

                                    </div>
                                    <button class="btn btn-block btn-success" id="btnReservarCita">Reservar</button>
                                    <input type="text" class="d-none" id="txtFechaInicio" />
                                    <input type="text" class="d-none" id="txtFechaFin" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

}
@section Scripts{
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDeN4HSjQCeTc-2xptNHY0kHVD0v_m5Qg	&callback=initMap">
    </script>
    <script>
        //Mapa Inicio
        function initMap() {
            var uluru = { lat: 18.491604, lng: -69.922173};
            var map = new google.maps.Map(document.getElementById('mapaConsultorioHayny'), {
                zoom: 20,
                center: uluru
            });
            var marker = new google.maps.Marker({
                position: uluru,
                map: map
            });
        }
        $(document).ready(function () {
            var HorasDeTrabajo = [
                {
                    inicio: new Date(2017, 1, 1, 9, 30),
                    fin: new Date(2017, 1, 1, 10, 30)
                },
                {
                    inicio: new Date(2017, 1, 1, 10, 30),
                    fin: new Date(2017, 1, 1, 11, 30)
                },
                {
                    inicio: new Date(2017, 1, 1, 11, 30),
                    fin: new Date(2017, 1, 1, 12, 30)
                }
            ];





            //Mapa fin
            $(".ImageBannerTextTitle").addTempClass({
                className: "animated fadeInDown"
            });

            $(".btnTipoCita").click(function () {
                $(".btnTipoCita").removeClass("btn-danger");
                $(".btnTipoCita").addClass("btn-info");
                $(this).removeClass("btn-info");
                $(this).addClass("btn-danger");
                $(".headerTotalConsulta").addClass("animated fadeIn");
                $("#MetodosPagoConsulta").addClass("animated fadeIn");

            });
            $(".btnTipoPago").click(function () {
                $(".btnTipoPago").removeClass("btn-danger");
                $(".btnTipoPago").addClass("btn-info");
                $(this).removeClass("btn-info");
                $(this).addClass("btn-danger");
            });
            setTimeout(function () {
                $(".ImageBannerTextSubTitle").addClass("animated fadeInDown");
                $("#btnSolicitarCita").addClass("animated fadeInDown")
            }, 1000)
            $("#calendar").fullCalendar({
                locale: "es",
                aspectRatio: 2.0,
                events: [
                    {
                        title: 'Cita con el Pedro',
                        start: "2018-02-04T11:30:00",
                        end: "2018-02-04T12:30:00"
                    },
                    {
                        title: 'Cita con el Juan',
                        start: "2018-02-05T09:30:00",
                        end: "2018-02-05T10:30:00"
                    },
                    {
                        title: 'Cita con el Maria',
                        start: "2018-02-05T10:30:00",
                        end: "2018-02-05T11:30:00"
                    },
                    {
                        title: 'Cita con el Pedro',
                        start: "2018-02-05T11:30:00",
                        end: "2018-02-05T12:30:00"
                    }
                ],
                dayClick: function (date, jsEvent, view) {

                    var fechaClickeada = new Date(date.format());
                    fechaClickeada.setDate(fechaClickeada.getDate() + 1);
                    //Obtiene los eventos del calendario de este dia
                    var eventosArray = $("#calendar").fullCalendar('getEventSources').map(function (x) {
                        return x.rawEventDefs;
                    }).reduce((a, b) => a.concat(b)).filter(function (e) {



                        var fechaFiltrada = new Date(e.start);

                        if (fechaClickeada.getFullYear() == fechaFiltrada.getFullYear() && fechaClickeada.getMonth() == fechaFiltrada.getMonth() && fechaClickeada.getDay() == fechaFiltrada.getDay()) {
                            return e
                        }
                    });

                    var HorasDisponibles = [];
                    //Encuentrame las horas que no estan en los eventos
                    HorasDeTrabajo.forEach(function (hora) {
                        var horasTemp = eventosArray.filter(function (ev) {

                            if (isSameTime(hora.inicio, new Date(ev.start))) {
                                return hora;
                            }
                        });
                        if (horasTemp.length === 0) {
                            HorasDisponibles.push(hora);
                        }
                    });

                    if (HorasDisponibles.length > 0) {
                        HorasDisponibles.forEach(function (hora) {
                            var horaInicio = moment(hora.inicio).format('YYYY-MM-DD[T]HH:mm:ss');
                            console.log(horaInicio);
                            var horaFin = moment(hora.fin).format('YYYY-MM-DD[T]HH:mm:ss');
                            console.log(horaFin);
                            $("#FechasDisponibles").append(
                                $("<a>", {
                                    class: "btnFechaCita btn btn-info m-2 text-white"
                                }).text(hora.inicio.getHours() + ":" + hora.inicio.getMinutes() + "-" + hora.fin.getHours() + ":" + hora.fin.getMinutes())
                                    .click(function () {
                                        $(".btnFechaCita").removeClass("btn-danger");
                                        $(".btnFechaCita").addClass("btn-info");
                                        $(this).removeClass("btn-info")
                                        $(this).addClass("btn-danger")
                                        $("#txtFechaInicio").val(horaInicio);
                                        $("#txtFechaFin").val(horaFin);
                                    })
                            )

                        })
                    } else {
                        $("#FechasDisponibles").append("<p class='LowImportance'>No hay horas disponibles</p>");
                    }


                    //console.log(eventosArray);


                    //alert('Clicked on: ' + date.format());

                    //alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);

                    //alert('Current view: ' + view.name);

                    // change the day's background color just for fun
                    $("#dayAgenda").fullCalendar('destroy');
                    $("#dayAgenda").fullCalendar({
                        locale: "es",
                        events: eventosArray,
                        header: {
                            left: 'title',
                            center: '',
                            right: ''
                        }
                    });
                    $('#NuevaCita').on('hidden.bs.modal', function (e) {
                        $("#FechasDisponibles").empty();
                        $('#dayAgenda').css("opacity", '0');
                    })
                    $('#NuevaCita').modal('show');
                    setTimeout(function () {
                        $('#dayAgenda').fullCalendar('changeView', 'listDay', fechaClickeada)
                        $('#dayAgenda').addTempClass({ className: 'animated fadeIn' })
                        $('#dayAgenda').css("opacity", '1');
                    }, 500)

                }
            });
            $("#calendar").fullCalendar('addEventSource', [
                {
                    title: 'Cita con el Juan',
                    start: "2018-02-06T09:30:00",
                    end: "2018-02-06T10:30:00"
                },
                {
                    title: 'Cita con el Maria',
                    start: "2018-02-06T10:30:00",
                    end: "2018-02-06T11:30:00"
                },
                {
                    title: 'Cita con el Pedro',
                    start: "2018-02-06T11:30:00",
                    end: "2018-02-06T12:30:00"
                }
            ]);
        });
    </script>
}